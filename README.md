# ten
テキストや画像、動画などの投稿、プライベートチャットを楽しめるSNSウェブアプリケーション。  
アプリ名に「ten」という単語を使ったのは、人々が交わる（クロス）というイメージを表現するためです。そのイメージに合うのが、「t」から始まり、漢字で「十」という意味を持つ「ten」という単語でした。

## URL
[https://ten.yuki-gakiya.com](https://ten.yuki-gakiya.com)

## Demo

## 概要
このSNSウェブアプリケーションは、テキストや画像などの投稿、相互フォロー、プライベートチャットなど、さまざまな機能を楽しむことができるものです。また、パソコンやタブレット、スマートフォンなど、どの端末でも使いやすいように、レスポンシブ対応のUIを採用しています。

## 主な機能


## 機能一覧
### アカウント
- アカウント作成
- Eメール認証
- ログイン
- プロフィール画像、年齢、場所、自己紹介などのプロフィール作成
- アカウントの削除
- パスワードのリセット

### 投稿
- テキストの投稿
- 画像の投稿
- 動画の投稿
- 投稿の削除
- 日付・時間指定による予約投稿

### ユーザーとのコミュニケーション
- ダイレクトメッセージ
- フォロー中、トレンド別のタイムライン表示
- ユーザー名、アカウント名でのユーザー検索
- 投稿に対するいいね機能
- 投稿への返信

### 通知
- 自分の投稿への返信
- 自分の投稿へのいいね
- フォロー
- ダイレクトメッセージの受信

## 作成の経緯
このSNSウェブアプリケーションの制作は、これまでの学習やプロジェクト作成を通じて得た知識とスキルを活かし、より大規模なプロジェクトに取り組むことを目指して始めました。独自のマイクロフレームワークを使用し、ゼロからアプリケーションを構築することで、将来的にどのようなバックエンドフレームワークを学習する際にも役立つスキルセットを身につけることを意図しています。

MVC（Model-View-Controller）アーキテクチャを採用し、データベースの管理にはマイグレーションベースを採用しました。また、データベースへのアクセスにはDAO（Data Access Object）を利用しています。

特にセキュリティへの取り組みには重点を置き、以下のセキュリティ対策を実装しました。

- セッションベースのユーザー認証
- ユーザー入力のバリデーション
- プリペアドステートメントの使用
- テキストの暗号化
- CSRF（Cross-Site Request Forgery）対策
- 署名付きURLの発行
- Eメールの検証

これらの実装についての詳細は、後述する「こだわった点」で解説します。

## 使用技術
### フロントエンド
| 項目                | 内容                         |
|---------------------|------------------------------|
| 使用言語            | HTML, CSS, Javascript        |
| CSSフレームワーク    | Tailwind     |
| Tailwindライブラリ   | flowbite, daisyUI     |
| 日付選択ライブラリ   | Flatpickr     |
| リアルタイム通信    | WebSocket    |
| パッケージ管理    | npm    |
| モジュールバンドラー    | webpack    |

### バックエンド
| 項目                | 内容                         |
|---------------------|------------------------------|
| 使用言語            | PHP                          |
| データベース        | MySQL                        |
| ジョブ管理ツール     | cron                      |
| 単体テスト     　　| PHPUnit                |
| メール送信     　　| PHPMailer                |
| リアルタイム通信    | Ratchet                        |
| プロセス制御システム  |  Supervisor                    |
| 画像編集            | ImageMagick                  |
| 動画編集            | ffmpeg                  |
| 日付操作            | Carbon                      |
| ダミーデータ        | Faker                       |
| ダミー画像        | Pixabay API                       |
| パッケージ管理      | Composer           　        |
| オートローダー      | Composer           　        |
| Webサーバー         | NGINX                        |
| サーバー            | Amazon EC2                   |
| SSL/TLS証明書更新    | Certbot                      |

## 期間
2024年1月18日から約2か月半かけて開発しました。

## こだわった点
### セキュリティ対策
安全なアプリケーションを開発するために、大きく以下の3つのセキュリティ対策を実装しました。

- 署名付きURLによる検証
- ミドルウェアによるアクセス制限
- ユーザー入力の検証

#### 署名付きURLによる検証
ユーザーが入力したEメールが有効かどうかを確認するEメール認証機能を導入しました。
これにより不正なアカウントの作成を防止します。

サーバーは[アカウント作成ページ](https://ten.yuki-gakiya.com/signup)で入力された情報を受け取ると、署名付きURLを作成し、入力されたEメール宛に送信します。
ユーザーが受信した署名付きURLを開くと、Eメールが有効であるとみなされアカウントが作成されます。

URLの署名には、サーバーサイドのシークレットキーとHMAC SHA256メッセージハッシュアルゴリズムを使用しました。
署名付きURLにはユーザーID、ハッシュ化されたEメール、有効期限を含めました。

サーバーが署名URLへのリクエストを受け取ると、現在のURLをシークレットキーでハッシュし、URLに埋め込まれた署名と比較して署名の有効性を検証します。
署名が有効であることが確認されると、ユーザーのアカウント作成が成功し、ログインが可能になります。

このフローを以下の図に示します。

また、パスワードリセット機能も同様の署名付きURLを使用して実装しています。
さらに、パスワードリセットの場合は、リクエストしたユーザーのIDとトークンを管理するためのパスワードリセットテーブルを使用しています。

### ミドルウェアによるアクセス制限
各ページへのアクセスはミドルウェアによって制限を行っています。

多くのページはログイン状態でかつ、Eメール認証済みのユーザーしか見ることができません。
例えばログインしていない状態で、ログインが必要なページ([https://ten.yuki-gakiya.com/messages](https://ten.yuki-gakiya.com/messages)など)に、アクセスすると下記の画像のように、アラートと共にログインページなどにリダイレクトされます。
これは[AuthenticatedMiddleware](https://github.com/AkinoJoey/SocialNetworkingService/blob/main/src/middleware/AuthenticatedMiddleware.php)によって行われます。
このように、ミドルウェアによってユーザーがログイン状態かどうか、Eメール認証済みかどうかなどを判断して、特定のページや機能へのアクセスを許可しています。

ユーザー認証に関しては、セッションベースのユーザー認証を採用しました。
ログインページで正しいEメールとパスワードが入力された場合、セッションデータにユーザーIDを添付してアクセスを許可します。
セッションが有効な限り、ユーザーはログイン状態を維持します。
各リクエストではクライアントにセッションデータが添付されているかどうかのみをチェックすればよく、サーバー側で毎回認証する必要はありません。

CSRF攻撃への対策として、GETメソッド以外のリクエストにCSRFトークンを追加しました。
サーバーはCSRFトークンが有効かどうかをチェックし、有効でない場合はリクエストがアプリケーションのロジックに入る前に拒否されます。
CSRFトークンの生成とCSRFトークンの検証は[CSRFMiddleware](https://github.com/AkinoJoey/SocialNetworkingService/blob/main/src/middleware/CSRFMiddleware.php)で行っています。


### cronによる定期スケジューリング

### Web Socketの活用

## これからの改善点、拡張案
